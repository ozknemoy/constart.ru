(function(){'use strict';angular.module('file-uploader',[]).factory('FileUploader',['$q',function($q){return{request:function(method,url,files,config){var deferred=$q.defer();if(files==null){deferred.reject('There\'s no files to upload');return deferred.promise;}
  var xhr=new XMLHttpRequest();xhr.upload.onprogress=function(event){if(event.lengthComputable){deferred.notify(Math.round((event.loaded/event.total)*100));}};xhr.onload=function(){var use='reject';if(xhr.status>=200&&xhr.status<300)
    use='resolve';deferred[use]({files:files,dataText:xhr.responseText,data:xhr.response,status:xhr.status,statusText:xhr.statusText});};xhr.upload.onerror=function(){var msg=xhr.responseText?xhr.responseText:'Error occurred uploading to '+url;deferred.reject(msg);return deferred.promise;};var fd=new FormData();if(config&&config.data!=null){if(typeof config.data==='object'){Object.keys(config.data).forEach(function(element){fd.append(element,config.data[element]);});}else{fd.append('data',config.data);}}
  function getNewFilename(fileName,baseName){var extension=fileName.match(/\..{3,4}$/)[0];var newFilename=baseName+extension;return newFilename;}
  if(files.length){for(var i=0;i<files.length;i++){if(config&&config.newNames&&config.newNames[files[i].name]!=null){var newName=getNewFilename(files[i].name,config.newNames[files[i].name]);fd.append(files[i].name,files[i],newName);}else if(config&&config.oldNames&&config.oldNames[files[i].name]!=null){fd.append(config.oldNames[files[i].name],files[i],files[i].name);}
  else{fd.append(files[i].name,files[i]);}}}else if(files&&config&&config.newNames){var newName=getNewFilename(files.name,config.newNames[files.name]);fd.append(files.name,files,newName);}else{fd.append(files.name,files);}
  xhr.open(method,url);if(config&&config.headers!=null){Object.keys(config.headers).forEach(function(element){xhr.setRequestHeader(element,config.headers[element]);});}
  if(config&&config.withCredentials!=null){xhr.withCredentials=config.withCredentials;}
  xhr.send(fd);return deferred.promise;},post:function(url,files,config){return this.request('POST',url,files,config);},send:function(url,files,config){return this.request('POST',url,files,config);},put:function(url,files,config){return this.request('PUT',url,files,config);}};}]);})();